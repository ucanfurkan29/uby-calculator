<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teorik Ağırlık Hesaplayıcı | Üçüncü Binyıl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0097FF',
                        darkNavy: '#002E4C',
                        darkFooter: '#00192A',
                        textGray: '#555555',
                        lightGray: '#F8F9FA'
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    boxShadow: {
                        card: '0 2px 20px rgba(0, 0, 0, 0.05)',
                        btn: '0 4px 10px rgba(0, 151, 255, 0.3)',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F8F9FA; color: #555555; }
        .input-field { transition: all 0.3s ease; border: 1px solid #E5E7EB; }
        .input-field:focus { border-color: #0097FF; box-shadow: 0 0 0 3px rgba(0, 151, 255, 0.1); }
        .select-field { transition: all 0.3s ease; border: 1px solid #E5E7EB; }
        .select-field:focus { border-color: #0097FF; box-shadow: 0 0 0 3px rgba(0, 151, 255, 0.1); }
    </style>
</head>

<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-darkNavy text-white sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="flex items-center group" aria-label="Üçüncü Binyıl - Ana Sayfa">
                    <img src="assets/img/logo.png" alt="Üçüncü Binyıl" class="h-10 w-auto group-hover:opacity-90 transition">
                </a>
            </div>
            <nav class="hidden md:flex gap-6 text-sm font-medium">
                <a href="index.html" class="hover:text-primary transition">Ana Sayfa</a>
                <a href="koni.html" class="hover:text-primary transition">Koni Hesaplayıcı</a>
                <a href="kfactor.html" class="hover:text-primary transition">K-Faktör Hesaplayıcı</a>
                <a href="agirlik.html" class="text-primary" aria-current="page">Teorik Ağırlık</a>
                <a href="makro-indir.html" class="hover:text-primary transition">Makro İndir</a>
                <a href="https://www.ucuncubinyil.com/iletisim" target="_blank" rel="noopener" class="hover:text-primary transition">İletişim</a>
            </nav>
            <button id="menuBtn" class="md:hidden inline-flex items-center justify-center p-2 rounded-lg bg-white/10 hover:bg-white/20 transition"
                type="button" aria-label="Menüyü Aç/Kapat" aria-controls="mobileMenu" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>
        <div id="mobileMenu" class="md:hidden hidden border-t border-white/10 bg-darkNavy/95 backdrop-blur">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-col gap-2 text-sm font-medium">
                <a href="index.html" class="hover:text-primary transition py-2">Ana Sayfa</a>
                <a href="koni.html" class="hover:text-primary transition py-2">Koni Hesaplayıcı</a>
                <a href="kfactor.html" class="hover:text-primary transition py-2">K-Faktör Hesaplayıcı</a>
                <a href="agirlik.html" class="text-primary py-2" aria-current="page">Teorik Ağırlık</a>
                <a href="makro-indir.html" class="hover:text-primary transition py-2">Makro İndir</a>
                <a href="https://www.ucuncubinyil.com/iletisim" target="_blank" rel="noopener"
                    class="hover:text-primary transition py-2">İletişim</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto w-full p-6 lg:p-10 space-y-8">

        <!-- Page Title -->
        <div class="text-center md:text-left border-b border-gray-200 pb-6">
            <span class="text-primary font-bold tracking-wider text-xs uppercase block mb-1">Teknik Araçlar</span>
            <h2 class="text-3xl md:text-4xl font-bold text-darkNavy">Teorik Ağırlık Hesaplayıcı</h2>
            <p class="text-gray-400 mt-2 text-sm max-w-2xl">Seçilen malzemenin özgül ağırlığı (yoğunluğu) ile seçilen formun hacmini çarparak teorik ağırlığı hesaplayın.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- Left Column: Inputs -->
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white rounded-[10px] shadow-card p-6 md:p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-darkNavy">Parametreler</h3>
                        <span class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-1 rounded">GİRDİ</span>
                    </div>

                    <form id="weightForm" class="space-y-5">

                        <!-- Material Group -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Malzeme Grubu</label>
                            <select id="materialGroup" class="select-field w-full rounded-lg bg-white p-3 text-sm text-darkNavy font-medium outline-none" onchange="onGroupChanged()">
                            </select>
                            <p class="text-[10px] text-gray-400 mt-1">Örn: Alüminyum, Çelik, Paslanmaz...</p>
                        </div>

                        <!-- Material Type -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Alaşım / Tür</label>
                            <select id="materialType" class="select-field w-full rounded-lg bg-white p-3 text-sm text-darkNavy font-medium outline-none" onchange="onTypeChanged()">
                            </select>
                            <p class="text-[10px] text-gray-400 mt-1">Yoğunluk otomatik seçilir.</p>
                        </div>

                        <!-- Form -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Form</label>
                            <select id="shape" class="select-field w-full rounded-lg bg-white p-3 text-sm text-darkNavy font-medium outline-none" onchange="onShapeChanged()">
                                <option value="plate">Levha / Lama / Dörtköşe (Prizmatik)</option>
                                <option value="rod">Çubuk (Silindir)</option>
                                <option value="pipe">Boru (İçi Boş Silindir)</option>
                                <option value="box">Kutu Profil (İçi Boş Prizma)</option>
                                <option value="hex">Altıköşe (Hexagon)</option>
                            </select>
                        </div>

                        <!-- Dynamic Inputs -->
                        <div id="shapeInputs" class="space-y-4">
                            <!-- Filled by JS -->
                        </div>

                        <!-- Quantity -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Adet</label>
                            <input type="number" id="quantity" value="1" min="1" class="input-field w-full rounded-lg bg-gray-50 p-3 text-sm font-bold text-darkNavy outline-none" oninput="calculateWeight()">
                        </div>

                        <div class="pt-2">
                            <button type="button" onclick="calculateWeight()" class="w-full bg-primary hover:bg-blue-500 text-white font-semibold py-4 px-6 rounded-[10px] shadow-btn transition-all active:scale-[0.98] text-sm tracking-wide uppercase">
                                Hesapla
                            </button>
                        </div>
                    </form>

                    <div id="warningBox" class="hidden mt-4 p-3 bg-red-50 text-red-600 text-xs font-medium rounded border border-red-100 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="warningText"></span>
                    </div>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-8 space-y-6">

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-[10px] shadow-card border-b-4 border-primary">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">Yoğunluk</div>
                        <div class="text-2xl font-bold text-darkNavy" id="resDensity">--</div>
                    </div>
                    <div class="bg-white p-5 rounded-[10px] shadow-card border-b-4 border-primary">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">Hacim</div>
                        <div class="text-2xl font-bold text-darkNavy" id="resVolume">--</div>
                    </div>
                    <div class="bg-white p-5 rounded-[10px] shadow-card border-b-4 border-purple-500">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">1 Adet Ağırlık</div>
                        <div class="text-2xl font-bold text-darkNavy" id="resWeightOne">--</div>
                    </div>
                    <div class="bg-white p-5 rounded-[10px] shadow-card border-b-4 border-green-500">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">Toplam Ağırlık</div>
                        <div class="text-2xl font-bold text-darkNavy" id="resWeightTotal">--</div>
                    </div>
                </div>

                <!-- Visualization -->
                <div class="bg-white p-6 rounded-[10px] shadow-card relative">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-darkNavy">Teknik Çizim / Önizleme</h3>
                        <div class="flex gap-4 text-xs">
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 bg-primary rounded-full opacity-20 border border-primary"></div>
                                <span class="text-gray-500">Geometri</span>
                            </div>
                        </div>
                    </div>
                    <div class="w-full h-[380px] flex justify-center items-center bg-gray-50 rounded-lg border border-gray-100 overflow-hidden relative">
                        <canvas id="weightCanvas"></canvas>
                        <div class="absolute bottom-4 right-4 text-[10px] text-gray-400 bg-white/80 p-2 rounded backdrop-blur-sm border border-gray-200">
                            *Otomatik Ölçeklendirilmiştir
                        </div>
                    </div>
                </div>

                <!-- Detailed Table -->
                <div class="bg-white rounded-[10px] shadow-card overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <h3 class="text-sm font-bold text-darkNavy uppercase tracking-wide">Detaylı Sonuç</h3>
                    </div>
                    <table class="w-full text-sm">
                        <tbody class="divide-y divide-gray-100">
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4 text-gray-600 font-medium">Seçilen Malzeme</td>
                                <td class="px-6 py-4 font-mono font-bold text-right text-darkNavy" id="resMaterial">--</td>
                            </tr>
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4 text-gray-600 font-medium">Form</td>
                                <td class="px-6 py-4 font-mono font-bold text-right text-darkNavy" id="resShape">--</td>
                            </tr>
                            <tr class="bg-purple-50/40 hover:bg-purple-50/60 transition">
                                <td class="px-6 py-4 text-purple-900 font-medium">Hacim</td>
                                <td class="px-6 py-4 font-mono font-bold text-right text-purple-900" id="resVolumeDetail">--</td>
                            </tr>
                            <tr class="bg-green-50/40 hover:bg-green-50/60 transition">
                                <td class="px-6 py-4 text-green-900 font-medium">Ağırlık (1 adet)</td>
                                <td class="px-6 py-4 font-mono font-bold text-right text-green-900" id="resWeightDetailOne">--</td>
                            </tr>
                            <tr class="bg-green-50/40 hover:bg-green-50/60 transition">
                                <td class="px-6 py-4 text-green-900 font-medium">Ağırlık (toplam)</td>
                                <td class="px-6 py-4 font-mono font-bold text-right text-green-900" id="resWeightDetailTotal">--</td>
                            </tr>
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4 text-gray-600 font-medium">Not</td>
                                <td class="px-6 py-4 text-right text-gray-500 text-xs" id="resNote">
                                    Ölçüler mm girilir. Yoğunluk g/cm³, sonuç kg olarak hesaplanır.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-darkFooter text-white py-12 border-t border-white/5 mt-10">
        <div class="max-w-7xl mx-auto px-6 text-center md:text-left">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div class="col-span-1 md:col-span-2">
                    <h3 class="text-xl font-bold mb-4">ÜÇÜNCÜ BİNYIL</h3>
                    <p class="text-gray-400 text-sm leading-relaxed max-w-sm">Mühendislik ve eğitimde mükemmeliyetin
                        adresi. Teknik hesaplama araçlarımız ile projelerinizde hız kazanın.</p>
                </div>
                <div>
                    <h4 class="font-bold mb-4 text-primary">Hızlı Linkler</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="index.html" class="hover:text-white transition">Ana Sayfa</a></li>
                        <li><a href="koni.html" class="hover:text-white transition">Koni Hesaplayıcı</a></li>
                        <li><a href="kfactor.html" class="hover:text-white transition">K-Faktör Hesaplayıcı</a></li>
                        <li><a href="agirlik.html" class="text-primary transition" aria-current="page">Teorik Ağırlık</a></li>
                        <li><a href="https://www.ucuncubinyil.com/hakkimizda" class="hover:text-white transition">Hakkımızda</a></li>
                        <li><a href="https://www.ucuncubinyil.com/egitimler" class="hover:text-white transition">Eğitimler</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4 text-primary">İletişim</h4>
                    <p class="text-sm text-gray-400">info@ucuncubinyil.com</p>
                    <p class="text-sm text-gray-400 mt-2">+90 212 123 45 67</p>
                </div>
            </div>
            <div class="border-t border-white/10 pt-8 flex flex-col md:flex-row justify-between items-center text-xs text-gray-500">
                <p>&copy; 2026 Üçüncü Binyıl Akademi. Tüm hakları saklıdır.</p>
                <div class="mt-2 md:mt-0">Design inspired by ucuncubinyil.com</div>
            </div>
        </div>
    </footer>

    <script>
        (function () {
            const btn = document.getElementById('menuBtn');
            const menu = document.getElementById('mobileMenu');
            if (!btn || !menu) return;

            function closeMenu() {
                menu.classList.add('hidden');
                btn.setAttribute('aria-expanded', 'false');
            }

            btn.addEventListener('click', function () {
                const willOpen = menu.classList.contains('hidden');
                menu.classList.toggle('hidden');
                btn.setAttribute('aria-expanded', String(willOpen));
            });

            menu.querySelectorAll('a').forEach(function (a) {
                a.addEventListener('click', closeMenu);
            });

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') closeMenu();
            });
        })();
    </script>

    <script>
        // --- MALZEME KÜTÜPHANESİ (Yoğunluk: g/cm³) ---
        // Not: İstersen bunu ayrı JSON dosyasına da taşıyabiliriz.
        const MATERIAL_LIBRARY = [
            {
                group: "Alüminyum",
                items: [
                    { name: "Alüminyum (Genel)", density: 2.70 },
                    { name: "Alüminyum 1050", density: 2.705 },
                    { name: "Alüminyum 6061", density: 2.70 },
                    { name: "Alüminyum 7075", density: 2.81 },
                ]
            },
            {
                group: "Çelik / Demir",
                items: [
                    { name: "Karbon Çeliği (Genel)", density: 7.85 },
                    { name: "DKP / Sac (Genel)", density: 7.85 },
                ]
            },
            {
                group: "Paslanmaz Çelik",
                items: [
                    { name: "Paslanmaz 304", density: 7.90 },
                    { name: "Paslanmaz 316", density: 8.00 },
                ]
            },
            {
                group: "Bakır",
                items: [
                    { name: "Bakır (Cu)", density: 8.96 },
                ]
            },
            {
                group: "Pirinç",
                items: [
                    { name: "Pirinç (Genel)", density: 8.50 },
                    { name: "Pirinç (Yüksek Zn)", density: 8.40 },
                    { name: "Pirinç (Düşük Zn)", density: 8.70 },
                ]
            },
            {
                group: "Plastik",
                items: [
                    { name: "Delrin / POM", density: 1.41 },
                    { name: "PA6 (Naylon)", density: 1.14 },
                    { name: "PE (Polietilen)", density: 0.95 },
                ]
            },
        ];

        const SHAPE_LABELS = {
            plate: "Levha / Lama / Dörtköşe (Prizmatik)",
            rod: "Çubuk (Silindir)",
            pipe: "Boru (İçi Boş Silindir)",
            box: "Kutu Profil (İçi Boş Prizma)",
            hex: "Altıköşe (Hexagon)"
        };

        function fmtTR(n, opts) {
            return n.toLocaleString('tr-TR', opts || { maximumFractionDigits: 3, minimumFractionDigits: 3 });
        }

        // --- CANVAS / TEKNİK ÇİZİM ---
        function resizeWeightCanvas() {
            const canvas = document.getElementById('weightCanvas');
            if (!canvas) return;
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        function drawGrid(ctx, w, h) {
            ctx.save();
            ctx.strokeStyle = '#E2E8F0';
            ctx.lineWidth = 0.5;
            const step = 20;
            ctx.beginPath();
            for (let x = 0; x <= w; x += step) { ctx.moveTo(x, 0); ctx.lineTo(x, h); }
            for (let y = 0; y <= h; y += step) { ctx.moveTo(0, y); ctx.lineTo(w, y); }
            ctx.stroke();
            ctx.restore();
        }

        function drawArrowHead(ctx, x, y, angle, len) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x - len * Math.cos(angle - Math.PI / 6), y - len * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(x - len * Math.cos(angle + Math.PI / 6), y - len * Math.sin(angle + Math.PI / 6));
            ctx.fill();
        }

        function drawDimension(ctx, x1, y1, x2, y2, text, offset, scale, color) {
            ctx.save();
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 1 / scale;

            const angle = Math.atan2(y2 - y1, x2 - x1);
            const perpX = Math.cos(angle + Math.PI / 2) * offset;
            const perpY = Math.sin(angle + Math.PI / 2) * offset;

            const ox1 = x1 + perpX;
            const oy1 = y1 + perpY;
            const ox2 = x2 + perpX;
            const oy2 = y2 + perpY;

            ctx.beginPath();
            ctx.setLineDash([2 / scale, 2 / scale]);
            ctx.moveTo(x1, y1); ctx.lineTo(ox1, oy1);
            ctx.moveTo(x2, y2); ctx.lineTo(ox2, oy2);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.beginPath();
            ctx.moveTo(ox1, oy1); ctx.lineTo(ox2, oy2);
            ctx.stroke();

            const headLen = 6 / scale;
            drawArrowHead(ctx, ox1, oy1, angle + Math.PI, headLen);
            drawArrowHead(ctx, ox2, oy2, angle, headLen);

            ctx.font = `bold ${12 / scale}px sans-serif`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            const midX = (ox1 + ox2) / 2;
            const midY = (oy1 + oy2) / 2;
            const textWidth = ctx.measureText(text).width;

            ctx.save();
            ctx.translate(midX, midY);
            ctx.fillStyle = 'rgba(255,255,255,0.85)';
            ctx.fillRect(-textWidth / 2 - 3 / scale, -8 / scale, textWidth + 6 / scale, 16 / scale);
            ctx.fillStyle = color;
            ctx.fillText(text, 0, 0);
            ctx.restore();

            ctx.restore();
        }

        function clearCanvasWithHint(msg) {
            const canvas = document.getElementById('weightCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width;
            const H = canvas.height;
            ctx.clearRect(0, 0, W, H);
            drawGrid(ctx, W, H);
            if (!msg) return;
            ctx.save();
            ctx.fillStyle = '#64748B';
            ctx.font = '600 12px Poppins, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(msg, W / 2, H / 2);
            ctx.restore();
        }

        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

        function hexToRgb(hex) {
            const h = (hex || '').replace('#', '').trim();
            if (h.length !== 6) return { r: 0, g: 0, b: 0 };
            return {
                r: parseInt(h.slice(0, 2), 16),
                g: parseInt(h.slice(2, 4), 16),
                b: parseInt(h.slice(4, 6), 16),
            };
        }

        function rgbToHex(r, g, b) {
            const to = (x) => clamp(Math.round(x), 0, 255).toString(16).padStart(2, '0');
            return `#${to(r)}${to(g)}${to(b)}`;
        }

        function shade(hex, amount) {
            // amount: -1..+1
            const { r, g, b } = hexToRgb(hex);
            const t = amount >= 0 ? 255 : 0;
            const p = Math.abs(amount);
            return rgbToHex(
                r + (t - r) * p,
                g + (t - g) * p,
                b + (t - b) * p
            );
        }

        const ISO_COS = Math.cos(Math.PI / 6); // 0.866
        const ISO_SIN = Math.sin(Math.PI / 6); // 0.5

        function projectIso(p3) {
            // p3: {x,y,z} in mm
            return {
                x: (p3.x - p3.y) * ISO_COS,
                y: (p3.x + p3.y) * ISO_SIN - p3.z
            };
        }

        function bbox2D(points2) {
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            points2.forEach(p => {
                if (p.x < minX) minX = p.x;
                if (p.y < minY) minY = p.y;
                if (p.x > maxX) maxX = p.x;
                if (p.y > maxY) maxY = p.y;
            });
            return { minX, minY, maxX, maxY, w: maxX - minX, h: maxY - minY };
        }

        function drawPoly(ctx, pts2, fill, stroke, lineW) {
            if (!pts2 || pts2.length < 3) return;
            ctx.beginPath();
            ctx.moveTo(pts2[0].x, pts2[0].y);
            for (let i = 1; i < pts2.length; i++) ctx.lineTo(pts2[i].x, pts2[i].y);
            ctx.closePath();
            if (fill) { ctx.fillStyle = fill; ctx.fill(); }
            if (stroke) {
                ctx.strokeStyle = stroke;
                ctx.lineWidth = lineW || 1;
                ctx.stroke();
            }
        }

        function drawFaceEvenOdd(ctx, outer2, inner2, fill, stroke, lineW) {
            if (!outer2 || outer2.length < 3) return;
            ctx.beginPath();
            ctx.moveTo(outer2[0].x, outer2[0].y);
            for (let i = 1; i < outer2.length; i++) ctx.lineTo(outer2[i].x, outer2[i].y);
            ctx.closePath();
            if (inner2 && inner2.length >= 3) {
                ctx.moveTo(inner2[0].x, inner2[0].y);
                for (let i = 1; i < inner2.length; i++) ctx.lineTo(inner2[i].x, inner2[i].y);
                ctx.closePath();
            }
            if (fill) { ctx.fillStyle = fill; ctx.fill('evenodd'); }
            if (stroke) {
                ctx.strokeStyle = stroke;
                ctx.lineWidth = lineW || 1;
                ctx.stroke();
            }
        }

        function drawOverlayBanner(text) {
            if (!text) return;
            const canvas = document.getElementById('weightCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width;

            ctx.save();
            ctx.font = '600 12px Poppins, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const paddingX = 16;
            const paddingY = 8;
            const textMetrics = ctx.measureText(text);
            const textWidth = textMetrics.width;
            
            // Kutu boyutları
            const boxW = Math.min(W - 24, textWidth + paddingX * 2);
            const boxH = 32;

            const x = W / 2;
            const y = 16; // Üstten mesafe

            // Gölge efekti (Material Design benzeri)
            ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetY = 4;

            // Arka plan ve kenarlık
            ctx.fillStyle = '#FFFFFF';
            ctx.strokeStyle = '#E2E8F0'; // lightGray-ish border
            ctx.lineWidth = 1;
            
            const left = x - boxW / 2;
            const top = y;
            const r = 8; // Köşe yuvarlaklığı

            ctx.beginPath();
            ctx.moveTo(left + r, top);
            ctx.arcTo(left + boxW, top, left + boxW, top + boxH, r);
            ctx.arcTo(left + boxW, top + boxH, left, top + boxH, r);
            ctx.arcTo(left, top + boxH, left, top, r);
            ctx.arcTo(left, top, left + boxW, top, r);
            ctx.closePath();
            
            ctx.fill();
            
            // Gölgeyi yazıya bulaştırmamak için kapat
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;
            
            ctx.stroke();

            // Yazı
            ctx.fillStyle = '#002E4C'; // darkNavy
            ctx.fillText(text, x, top + boxH / 2);
            ctx.restore();
        }

        function updateVisualization() {
            const canvas = document.getElementById('weightCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width;
            const H = canvas.height;
            ctx.clearRect(0, 0, W, H);
            drawGrid(ctx, W, H);

            const shape = document.getElementById('shape').value;

            const dims = (() => {
                if (shape === "plate") return { t: getNum('t'), w: getNum('w'), l: getNum('l') };
                if (shape === "rod") return { d: getNum('d'), l: getNum('l') };
                if (shape === "pipe") return { do: getNum('do'), t: getNum('t'), l: getNum('l') };
                if (shape === "box") return { w: getNum('w'), h: getNum('h'), t: getNum('t'), l: getNum('l') };
                if (shape === "hex") return { af: getNum('af'), l: getNum('l') };
                return {};
            })();

            const vals = Object.values(dims);
            if (!vals.length || vals.some(v => !(v > 0))) {
                clearCanvasWithHint("Ölçü girince 3D önizleme oluşur.");
                return;
            }

            // 3D sahne (mm) - merkezi orijine alıp izometrik projeksiyon ile çiziyoruz.
            // x: boy (ekstrüzyon), y: genişlik/çap yönü, z: yükseklik/kalınlık yönü
            const BASE = '#0097FF';
            const OUTLINE = '#334155';
            const METAL = '#94A3B8';

            // yüzey listesi: { pts3: [{x,y,z}], fill, stroke, key }
            const faces = [];
            let overlayText = "";

            function addFace(pts3, fill, stroke, depthKey) {
                const key = typeof depthKey === 'number' ? depthKey : pts3.reduce((s, p) => s + (p.x + p.y), 0) / pts3.length;
                faces.push({ pts3, fill, stroke, key });
            }

            function addFaceLoop(frontLoopYZ, x0, x1, fillSideBase, stroke) {
                // frontLoopYZ: [{y,z}] closed loop not required (we will wrap)
                const n = frontLoopYZ.length;
                for (let i = 0; i < n; i++) {
                    const a = frontLoopYZ[i];
                    const b = frontLoopYZ[(i + 1) % n];
                    const quad = [
                        { x: x0, y: a.y, z: a.z },
                        { x: x0, y: b.y, z: b.z },
                        { x: x1, y: b.y, z: b.z },
                        { x: x1, y: a.y, z: a.z },
                    ];
                    const shadeAmt = 0.10 + 0.20 * Math.abs(Math.cos((i / n) * Math.PI * 2));
                    addFace(quad, shade(fillSideBase, -shadeAmt), stroke);
                }
            }

            function addFrontBack(outerYZ, innerYZ, x, fill, stroke) {
                // Front/back yüzeyi (hollow için even-odd)
                const outer3 = outerYZ.map(p => ({ x, y: p.y, z: p.z }));
                const inner3 = innerYZ ? innerYZ.map(p => ({ x, y: p.y, z: p.z })) : null;
                // 2D'e dönüşüm sonraki aşamada; burada depth key'i sabit verelim
                const key = outer3.reduce((s, p) => s + (p.x + p.y), 0) / outer3.length;
                faces.push({ pts3: outer3, inner3, fill, stroke, key, evenOdd: !!inner3 });
            }

            function rectPrism(L, Wd, Ht, baseColor) {
                const x0 = -L / 2, x1 = L / 2;
                const y0 = -Wd / 2, y1 = Wd / 2;
                const z0 = -Ht / 2, z1 = Ht / 2;

                const V = {
                    A: { x: x0, y: y0, z: z0 },
                    B: { x: x1, y: y0, z: z0 },
                    C: { x: x1, y: y1, z: z0 },
                    D: { x: x0, y: y1, z: z0 },
                    E: { x: x0, y: y0, z: z1 },
                    F: { x: x1, y: y0, z: z1 },
                    G: { x: x1, y: y1, z: z1 },
                    H: { x: x0, y: y1, z: z1 },
                };

                // 6 yüz
                addFace([V.E, V.F, V.G, V.H], shade(baseColor, 0.18), OUTLINE); // üst
                addFace([V.A, V.B, V.C, V.D], shade(baseColor, -0.25), OUTLINE); // alt
                addFace([V.B, V.C, V.G, V.F], shade(baseColor, -0.10), OUTLINE); // +y
                addFace([V.A, V.D, V.H, V.E], shade(baseColor, -0.18), OUTLINE); // -y
                addFace([V.A, V.B, V.F, V.E], shade(baseColor, -0.06), OUTLINE); // -z? (ön)
                addFace([V.D, V.C, V.G, V.H], shade(baseColor, -0.14), OUTLINE); // arka
            }

            // Şekle göre mesh oluştur
            if (shape === "plate") {
                const { l, w, t } = dims;
                rectPrism(l, w, t, BASE);
                overlayText = `Boy:${l} mm • En:${w} mm • Kalınlık:${t} mm`;
            } else if (shape === "rod") {
                const { l, d } = dims;
                const r = d / 2;
                const x0 = -l / 2, x1 = l / 2;
                const seg = 40;
                const loop = [];
                for (let i = 0; i < seg; i++) {
                    const a = (i / seg) * Math.PI * 2;
                    loop.push({ y: Math.cos(a) * r, z: Math.sin(a) * r });
                }
                addFrontBack(loop, null, x0, shade(METAL, 0.15), OUTLINE);
                addFrontBack(loop, null, x1, shade(METAL, -0.05), OUTLINE);
                addFaceLoop(loop, x0, x1, METAL, OUTLINE);
                overlayText = `Boy:${l} mm • Çap:${d} mm`;
            } else if (shape === "pipe") {
                const { l, do: doMm, t } = dims;
                const diMm = doMm - 2 * t;
                if (!(diMm > 0)) { clearCanvasWithHint("Boru: İç çap pozitif olmalı."); return; }
                const ro = doMm / 2;
                const ri = diMm / 2;
                const x0 = -l / 2, x1 = l / 2;
                const seg = 48;
                const outer = [];
                const inner = [];
                for (let i = 0; i < seg; i++) {
                    const a = (i / seg) * Math.PI * 2;
                    outer.push({ y: Math.cos(a) * ro, z: Math.sin(a) * ro });
                    inner.push({ y: Math.cos(-a) * ri, z: Math.sin(-a) * ri }); // ters yön (evenodd için)
                }
                addFrontBack(outer, inner, x0, shade(METAL, 0.12), OUTLINE);
                addFrontBack(outer, inner, x1, shade(METAL, -0.08), OUTLINE);
                addFaceLoop(outer, x0, x1, METAL, OUTLINE); // dış yüzey
                addFaceLoop(inner, x1, x0, shade(METAL, -0.25), OUTLINE); // iç yüzey (ters ekstrüzyon)
                overlayText = `Boy:${l} mm • Dış Çap:${doMm} mm • Et:${t} mm`;
            } else if (shape === "box") {
                const { l, w, h, t } = dims;
                const wi = w - 2 * t;
                const hi = h - 2 * t;
                if (!(wi > 0 && hi > 0)) { clearCanvasWithHint("Kutu profil: İç ölçüler pozitif olmalı."); return; }
                const x0 = -l / 2, x1 = l / 2;

                const outer = [
                    { y: -w / 2, z: -h / 2 },
                    { y: w / 2, z: -h / 2 },
                    { y: w / 2, z: h / 2 },
                    { y: -w / 2, z: h / 2 },
                ];
                const inner = [
                    { y: -wi / 2, z: -hi / 2 },
                    { y: wi / 2, z: -hi / 2 },
                    { y: wi / 2, z: hi / 2 },
                    { y: -wi / 2, z: hi / 2 },
                ];

                // gövde: dış yüzeyler
                addFaceLoop(outer, x0, x1, BASE, OUTLINE);
                // iç yüzeyler (ters)
                addFaceLoop(inner, x1, x0, shade(BASE, -0.25), OUTLINE);

                // ön/arka yüz: delikli
                addFrontBack(outer, inner, x0, shade(BASE, 0.14), OUTLINE);
                addFrontBack(outer, inner, x1, shade(BASE, -0.08), OUTLINE);

                overlayText = `Boy:${l} mm • W:${w} mm • H:${h} mm • Et:${t} mm`;
            } else if (shape === "hex") {
                const { l, af } = dims;
                const x0 = -l / 2, x1 = l / 2;
                const R = af / Math.sqrt(3);
                const loop = [];
                for (let i = 0; i < 6; i++) {
                    const ang = (Math.PI / 6) + (i * Math.PI / 3);
                    loop.push({ y: Math.cos(ang) * R, z: Math.sin(ang) * R });
                }
                addFrontBack(loop, null, x0, shade('#10b981', 0.12), OUTLINE);
                addFrontBack(loop, null, x1, shade('#10b981', -0.08), OUTLINE);
                addFaceLoop(loop, x0, x1, '#10b981', OUTLINE);
                overlayText = `Boy:${l} mm • AF:${af} mm`;
            }

            // tüm 3D noktaları projekte edip bbox bul
            const all2 = [];
            faces.forEach(f => {
                (f.pts3 || []).forEach(p => all2.push(projectIso(p)));
                if (f.inner3) f.inner3.forEach(p => all2.push(projectIso(p)));
            });
            if (!all2.length) { clearCanvasWithHint("Önizleme oluşturulamadı."); return; }
            const bb = bbox2D(all2);

            const padding = 120;
            const availableW = W - padding;
            const availableH = H - padding;
            let scale = 1;
            if (bb.w > 0 && bb.h > 0) scale = Math.min(availableW / bb.w, availableH / bb.h);
            if (scale > 6) scale = 6;

            const transX = (W / 2) - (bb.minX + bb.w / 2) * scale;
            const transY = (H / 2) - (bb.minY + bb.h / 2) * scale;

            ctx.save();
            ctx.translate(transX, transY);
            ctx.scale(scale, scale);

            // yüzeyleri “uzak -> yakın” çiz
            faces.sort((a, b) => a.key - b.key);
            faces.forEach(f => {
                const outer2 = f.pts3.map(projectIso);
                if (f.evenOdd) {
                    const inner2 = (f.inner3 || []).map(projectIso);
                    drawFaceEvenOdd(ctx, outer2, inner2, f.fill, f.stroke, 1.2 / scale);
                } else {
                    drawPoly(ctx, outer2, f.fill, f.stroke, 1.2 / scale);
                }
            });

            // hafif parlaklık çizgisi
            ctx.save();
            ctx.globalAlpha = 0.18;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1.2 / scale;
            ctx.beginPath();
            ctx.moveTo(bb.minX, bb.minY);
            ctx.lineTo(bb.maxX, bb.minY);
            ctx.stroke();
            ctx.restore();
            ctx.restore();

            // yazı sabit: kareli kağıdın üst-orta tarafında
            drawOverlayBanner(overlayText);
        }

        function showError(msg) {
            const box = document.getElementById('warningBox');
            const txt = document.getElementById('warningText');
            txt.innerText = msg;
            box.classList.remove('hidden');
            updateVisualization();
        }

        function hideError() {
            document.getElementById('warningBox').classList.add('hidden');
        }

        function mmToCm(mm) {
            return mm / 10.0;
        }

        function getSelectedMaterial() {
            const groupIdx = parseInt(document.getElementById('materialGroup').value, 10);
            const typeIdx = parseInt(document.getElementById('materialType').value, 10);
            const group = MATERIAL_LIBRARY[groupIdx];
            const item = group && group.items ? group.items[typeIdx] : null;
            return item ? { group: group.group, ...item } : null;
        }

        function onGroupChanged() {
            const groupSelect = document.getElementById('materialGroup');
            const typeSelect = document.getElementById('materialType');

            const idx = parseInt(groupSelect.value, 10);
            const group = MATERIAL_LIBRARY[idx];
            typeSelect.innerHTML = "";

            (group?.items || []).forEach((it, i) => {
                const opt = document.createElement('option');
                opt.value = String(i);
                opt.textContent = `${it.name} (${it.density.toFixed(3)} g/cm³)`;
                typeSelect.appendChild(opt);
            });

            calculateWeight();
        }

        function onTypeChanged() {
            calculateWeight();
        }

        function onShapeChanged() {
            renderShapeInputs();
            calculateWeight();
        }

        function inputRow({ id, label, placeholder, help }) {
            const helpHtml = help ? `<p class="text-[10px] text-gray-400 mt-1">${help}</p>` : "";
            return `
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">${label}</label>
                    <input type="number" id="${id}" class="input-field w-full rounded-lg bg-gray-50 p-3 text-sm font-bold text-darkNavy outline-none" placeholder="${placeholder || ''}" oninput="calculateWeight()">
                    ${helpHtml}
                </div>
            `;
        }

        function renderShapeInputs() {
            const shape = document.getElementById('shape').value;
            const wrap = document.getElementById('shapeInputs');

            if (shape === "plate") {
                wrap.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        ${inputRow({ id: "t", label: "Kalınlık (mm)", placeholder: "t", help: "" })}
                        ${inputRow({ id: "w", label: "En (mm)", placeholder: "W" })}
                    </div>
                    ${inputRow({ id: "l", label: "Boy (mm)", placeholder: "L" })}
                `;
                setDefaults({ t: 2, w: 25, l: 100 });
            } else if (shape === "rod") {
                wrap.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        ${inputRow({ id: "d", label: "Çap (mm)", placeholder: "Ø" })}
                        ${inputRow({ id: "l", label: "Boy (mm)", placeholder: "L" })}
                    </div>
                `;
                setDefaults({ d: 20, l: 100 });
            } else if (shape === "pipe") {
                wrap.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        ${inputRow({ id: "do", label: "Dış Çap (mm)", placeholder: "Ø dış" })}
                        ${inputRow({ id: "t", label: "Et Kalınlığı (mm)", placeholder: "t" })}
                    </div>
                    ${inputRow({ id: "l", label: "Boy (mm)", placeholder: "L" })}
                `;
                setDefaults({ do: 30, t: 2, l: 100 });
            } else if (shape === "box") {
                wrap.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        ${inputRow({ id: "w", label: "Genişlik (mm)", placeholder: "W" })}
                        ${inputRow({ id: "h", label: "Yükseklik (mm)", placeholder: "H" })}
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        ${inputRow({ id: "t", label: "Et Kalınlığı (mm)", placeholder: "t" })}
                        ${inputRow({ id: "l", label: "Boy (mm)", placeholder: "L" })}
                    </div>
                `;
                setDefaults({ w: 40, h: 40, t: 2, l: 100 });
            } else if (shape === "hex") {
                wrap.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        ${inputRow({ id: "af", label: "Anahtar Ağzı (mm)", placeholder: "Karşılıklı düz yüzey" })}
                        ${inputRow({ id: "l", label: "Boy (mm)", placeholder: "L" })}
                    </div>
                    <div class="p-3 rounded-lg bg-gray-50 border border-gray-100 text-[11px] text-gray-500 leading-relaxed">
                        Altıköşe için pratik kesit alanı formülü: <span class="font-mono font-bold text-darkNavy">A = (√3 / 2) × AF²</span>
                    </div>
                `;
                setDefaults({ af: 17, l: 100 });
            } else {
                wrap.innerHTML = "";
            }
        }

        function setDefaults(map) {
            Object.keys(map).forEach((k) => {
                const el = document.getElementById(k);
                if (!el) return;
                // sadece boşsa default bas (kullanıcı girdisini bozmayalım)
                if (el.value === "" || el.value === null || typeof el.value === "undefined") {
                    el.value = map[k];
                }
            });
        }

        function getNum(id) {
            const el = document.getElementById(id);
            if (!el) return NaN;
            const v = parseFloat(el.value);
            return isFinite(v) ? v : NaN;
        }

        function volumeCm3FromInputs(shape) {
            // tüm ölçüler mm girilir -> cm'e çevrilir
            if (shape === "plate") {
                const t = getNum('t'), w = getNum('w'), l = getNum('l');
                if (!(t > 0 && w > 0 && l > 0)) throw new Error("Lütfen tüm ölçüleri pozitif giriniz.");
                return mmToCm(t) * mmToCm(w) * mmToCm(l);
            }

            if (shape === "rod") {
                const d = getNum('d'), l = getNum('l');
                if (!(d > 0 && l > 0)) throw new Error("Lütfen çap ve boyu pozitif giriniz.");
                const r = mmToCm(d) / 2;
                return Math.PI * r * r * mmToCm(l);
            }

            if (shape === "pipe") {
                const doMm = getNum('do'), tMm = getNum('t'), l = getNum('l');
                if (!(doMm > 0 && tMm > 0 && l > 0)) throw new Error("Lütfen tüm ölçüleri pozitif giriniz.");
                const diMm = doMm - 2 * tMm;
                if (!(diMm > 0)) throw new Error("Hata: İç çap (Dış Çap - 2×Et) pozitif olmalıdır.");
                const ro = mmToCm(doMm) / 2;
                const ri = mmToCm(diMm) / 2;
                return Math.PI * (ro * ro - ri * ri) * mmToCm(l);
            }

            if (shape === "box") {
                const wMm = getNum('w'), hMm = getNum('h'), tMm = getNum('t'), l = getNum('l');
                if (!(wMm > 0 && hMm > 0 && tMm > 0 && l > 0)) throw new Error("Lütfen tüm ölçüleri pozitif giriniz.");
                const wiMm = wMm - 2 * tMm;
                const hiMm = hMm - 2 * tMm;
                if (!(wiMm > 0 && hiMm > 0)) throw new Error("Hata: İç ölçüler (W-2t, H-2t) pozitif olmalıdır.");
                const areaOuter = mmToCm(wMm) * mmToCm(hMm);
                const areaInner = mmToCm(wiMm) * mmToCm(hiMm);
                return (areaOuter - areaInner) * mmToCm(l);
            }

            if (shape === "hex") {
                const afMm = getNum('af'), l = getNum('l');
                if (!(afMm > 0 && l > 0)) throw new Error("Lütfen anahtar ağzı ve boyu pozitif giriniz.");
                const af = mmToCm(afMm);
                const area = (Math.sqrt(3) / 2) * af * af; // cm^2
                return area * mmToCm(l);
            }

            throw new Error("Geçersiz form seçimi.");
        }

        function setResultsEmpty() {
            document.getElementById('resDensity').innerText = "--";
            document.getElementById('resVolume').innerText = "--";
            document.getElementById('resWeightOne').innerText = "--";
            document.getElementById('resWeightTotal').innerText = "--";
            document.getElementById('resMaterial').innerText = "--";
            document.getElementById('resShape').innerText = "--";
            document.getElementById('resVolumeDetail').innerText = "--";
            document.getElementById('resWeightDetailOne').innerText = "--";
            document.getElementById('resWeightDetailTotal').innerText = "--";
        }

        function calculateWeight() {
            hideError();
            setResultsEmpty();

            const material = getSelectedMaterial();
            if (!material) return;

            const shape = document.getElementById('shape').value;
            const qty = parseInt(document.getElementById('quantity').value, 10) || 1;
            if (qty < 1) {
                showError("Adet en az 1 olmalıdır.");
                return;
            }

            let volumeCm3 = 0;
            try {
                volumeCm3 = volumeCm3FromInputs(shape);
            } catch (e) {
                showError(String(e.message || e));
                return;
            }

            const density = material.density; // g/cm3
            const grams = density * volumeCm3;
            const kgOne = grams / 1000;
            const kgTotal = kgOne * qty;

            document.getElementById('resDensity').innerText = `${density.toFixed(3)} g/cm³`;
            document.getElementById('resVolume').innerText = `${fmtTR(volumeCm3, { maximumFractionDigits: 2, minimumFractionDigits: 2 })} cm³`;
            document.getElementById('resWeightOne').innerText = `${fmtTR(kgOne, { maximumFractionDigits: 3, minimumFractionDigits: 3 })} kg`;
            document.getElementById('resWeightTotal').innerText = `${fmtTR(kgTotal, { maximumFractionDigits: 3, minimumFractionDigits: 3 })} kg`;

            document.getElementById('resMaterial').innerText = `${material.group} / ${material.name}`;
            document.getElementById('resShape').innerText = SHAPE_LABELS[shape] || shape;
            document.getElementById('resVolumeDetail').innerText = `${fmtTR(volumeCm3, { maximumFractionDigits: 3, minimumFractionDigits: 3 })} cm³`;
            document.getElementById('resWeightDetailOne').innerText = `${fmtTR(kgOne, { maximumFractionDigits: 4, minimumFractionDigits: 4 })} kg`;
            document.getElementById('resWeightDetailTotal').innerText = `${fmtTR(kgTotal, { maximumFractionDigits: 4, minimumFractionDigits: 4 })} kg`;

            updateVisualization();
        }

        function initMaterials() {
            const groupSelect = document.getElementById('materialGroup');
            groupSelect.innerHTML = "";
            MATERIAL_LIBRARY.forEach((g, i) => {
                const opt = document.createElement('option');
                opt.value = String(i);
                opt.textContent = g.group;
                groupSelect.appendChild(opt);
            });
        }

        window.onload = function () {
            initMaterials();
            renderShapeInputs();
            onGroupChanged();
            resizeWeightCanvas();
            calculateWeight();
        };

        window.onresize = function () {
            resizeWeightCanvas();
            updateVisualization();
        };
    </script>

</body>

</html>

